% Model-free analysis of behavior on experiment RLVSL
%
clear all;
close all;
addpath('./Toolboxes');
condtypes = ["Repeating","Alternating","Random"];
%% Load data
ifig = 1;
nsubjtot    = 31;
excluded    = [1];
subjlist    = setdiff(1:nsubjtot, excluded);
subparsubjs = [excluded 23 28];
subjlist = setdiff(1:nsubjtot, subparsubjs); % if excluding underperforming/people who didn't get it
% load experiment structure
nsubj = numel(subjlist);
% Data manip step
filename = sprintf('./Data/S%02d/RLVSL_S%02d_expe.mat',2,2);
load(filename,'expe');
nt = expe(1).cfg.ntrls;
nb = expe(1).cfg.nbout;
ntrain = expe(1).cfg.ntrain;
nc = 3;
nb_c = nb/nc;

blcks       = nan(nb_c,nt,3,nsubj);
resps       = nan(nb_c,nt,3,nsubj);
rts         = nan(nb_c,nt,3,nsubj);

mu_new   = 55;  % mean of higher distribution
fnr      = .25; % Desired false negative rate of higher distribution
func     = @(sig)fnr-normcdf(50,55,sig);
sig_opti = fzero(func,15);

a = sig_opti/expe(1).cfg.sgen;      % slope of linear transformation aX+b
b = mu_new - a*expe(1).cfg.mgen;    % intercept of linear transf. aX+b

run_epiphany_qts; % get epiphany quarters

for isubj = subjlist
    filename = sprintf('./Data/S%02d/RLVSL_S%02d_expe.mat',isubj,isubj);
    fprintf('Loading subject %d...\n',isubj);
    load(filename,'expe');
    ib_c = ones(3,1);
    for ib = 1+ntrain:nb+ntrain
        ctype = expe(ib).type;
        switch ctype
            case 'rnd' % random across successive blocks
                icond = 3;
            case 'alt' % always alternating
                icond = 2;
            case 'rep' % always the same
                icond = 1;
        end

        resp_mult = -(expe(ib).resp-1.5)*2;
        blcks(ib_c(icond),:,icond,isubj) = round(resp_mult.*expe(ib).blck*a+b);
        
        rts(ib_c(icond),:,icond,isubj) = expe(ib).rt;
        ib_c(icond) = ib_c(icond)+1;
    end
end
blcks = (blcks-50)/100;

%% 1a. Organize: Correlation between feedback magnitude and RT

coefs_rt_fb = zeros(nsubj,4,nc); 
pvals = zeros(nc,4);

for icond = 1:nc
    for iq = 1:4
        for isubj = 1:nsubj
            blockrange = 4*(iq-1)+1:4*(iq-1)+4;
            rts_vec = rts(blockrange,2:nt,icond,subjlist(isubj)); % rts on trial t
            rts_vec = rts_vec(:);
            rsp_vec = blcks(blockrange,1:nt-1,icond,subjlist(isubj)); % fb on trial t-1
            rsp_vec = rsp_vec(:);
            bval = regress(rts_vec,[ones(size(rsp_vec)) rsp_vec]);
            coefs_rt_fb(isubj,iq,icond) = bval(2);
            
        end 
        [~,pvals(icond,iq)] = ttest(coefs_rt_fb(:,iq,icond));
    end
end

%% 1b. Plot: Correlation between feedback magnitude and RT
figure;
hold on;
handleVis = 'off';
for icond = 1:nc
    for iq = 1:4
        if iq == 4
            handleVis = 'on';
        end
        scatter(iq,mean(coefs_rt_fb(:,iq,icond)),'filled','MarkerEdgeColor',graded_rgb(icond,iq,4),'MarkerFaceColor',graded_rgb(icond,iq,4),...
                'HandleVisibility',handleVis);
        errorbar(iq,mean(coefs_rt_fb(:,iq,icond)),std(coefs_rt_fb(:,iq,icond))/sqrt(nsubj),'Color',graded_rgb(icond,iq,4),...
                'HandleVisibility','off');
        text(iq+.1,mean(coefs_rt_fb(:,iq,icond)),sigstar(pvals(icond,iq)));
    end
    handleVis = 'off';
end
XTick = 1:4;
set(gca,'xtick',XTick);
yline(0,':');
ylabel('Regression weight beta','FontSize',14);
xlabel('Quarter','FontSize',14);
xlim([.5 4.5]);
legend(condtypes,'Location','southeast');
title(sprintf('Effect of feedback value on reaction times\nError bars: SEM'),'FontSize',12);

%% 2a. Organize: Correlation between feedback magnitude and RT before and after epiphanies within conditions
coefs_rt_fb_epiph_rep = zeros(nsubj,2); 
coefs_rt_fb_epiph_alt = zeros(nsubj,2); 
coefs_rt_fb_epiph_r_rnd   = zeros(nsubj,2);
coefs_rt_fb_epiph_a_rnd   = zeros(nsubj,2);

pvals_epiph = zeros(2,2);
pvals_epiph_rnd = zeros(2,2);

pre_ep_qts = 0;
for icond = 1:2
    isubj = 0;
    excl_epiph = [];
    for subj = subjlist
        isubj = isubj + 1;
        % pre and post epiphany analysis
        if icond == 1
            if ~isempty(prepost_epiph_rep{subj,1})
                pre_ep_qts = prepost_epiph_rep{subj,1};
            else
                excl_epiph = [excl_epiph isubj];
                continue
            end
        elseif icond == 2
            if ~isempty(prepost_epiph_alt{subj,1})
                pre_ep_qts = prepost_epiph_alt{subj,1};
            else 
                excl_epiph = [excl_epiph isubj];
                continue
            end
        end

        % Regression analysis
        blockrange= [];
        for iq = pre_ep_qts
            blockrange = [blockrange 4*(iq-1)+1:4*(iq-1)+4];
        end
        for iepiph = 1:2
            if iepiph == 2 % after epiphany
                blockrange = setdiff(1:16,blockrange);
            end
            rts_vec = rts(blockrange,2:nt,icond,subj); % rts on trial t
            rts_vec = rts_vec(:);
            rsp_vec = blcks(blockrange,1:nt-1,icond,subj); % fb on trial t-1
            rsp_vec = rsp_vec(:);
            bval_epiph = regress(rts_vec,[ones(size(rsp_vec)) rsp_vec]);
            if icond == 1
                coefs_rt_fb_epiph_rep(isubj,iepiph) = bval_epiph(2);
            else
                coefs_rt_fb_epiph_alt(isubj,iepiph) = bval_epiph(2);
            end

            % Regress on the RND condition with the same quarters as control
            rts_vec = rts(blockrange,2:nt,3,subj); % rts on trial t
            rts_vec = rts_vec(:);
            rsp_vec = blcks(blockrange,1:nt-1,3,subj); % fb on trial t-1
            rsp_vec = rsp_vec(:);
            bval_epiph = regress(rts_vec,[ones(size(rsp_vec)) rsp_vec]);
            if icond == 1
                coefs_rt_fb_epiph_r_rnd(isubj,iepiph) = bval_epiph(2);
            else
                coefs_rt_fb_epiph_a_rnd(isubj,iepiph) = bval_epiph(2);
            end
        end
    end
    
    if icond == 1
        coefs_rt_fb_epiph_rep(excl_epiph,:,:)   = [];
        coefs_rt_fb_epiph_r_rnd(excl_epiph,:,:) = [];
        [~,pvals_epiph(icond,1)] = ttest(coefs_rt_fb_epiph_rep(:,1));
        [~,pvals_epiph(icond,2)] = ttest(coefs_rt_fb_epiph_rep(:,2));
        [~,pvals_epiph_rnd(icond,1)] = ttest(coefs_rt_fb_epiph_r_rnd(:,1));
        [~,pvals_epiph_rnd(icond,2)] = ttest(coefs_rt_fb_epiph_r_rnd(:,2));
    else
        coefs_rt_fb_epiph_alt(excl_epiph,:,:)   = [];
        coefs_rt_fb_epiph_a_rnd(excl_epiph,:,:) = [];
        [~,pvals_epiph(icond,1)] = ttest(coefs_rt_fb_epiph_alt(:,1));
        [~,pvals_epiph(icond,2)] = ttest(coefs_rt_fb_epiph_alt(:,2));
        [~,pvals_epiph_rnd(icond,1)] = ttest(coefs_rt_fb_epiph_a_rnd(:,1));
        [~,pvals_epiph_rnd(icond,2)] = ttest(coefs_rt_fb_epiph_a_rnd(:,2));
    end
    
    pre_ep_qts = 0;
end

%% 2b. Statistics: Correlation between feedback magnitude and RT before and after epiphanies within conditions
% 
epiph_data_rep = cat(3,coefs_rt_fb_epiph_rep,coefs_rt_fb_epiph_r_rnd);
epiph_data_alt = cat(3,coefs_rt_fb_epiph_alt,coefs_rt_fb_epiph_a_rnd);

tbl_epiph_rep = simple_mixed_anova(epiph_data_rep,[],{'Epiphany','Condition'});
tbl_epiph_alt = simple_mixed_anova(epiph_data_alt,[],{'Epiphany','Condition'});

%% 2c. Plot: Correlation between feedback magnitude and RT before and after epiphanies within conditions
figure;
hold on;
handleVis = 'off';
mrkshape = '';
for icond = 1:2
    if icond == 2
        mrkshape = '^';
    end
    for iepiph = 1:2
        if iepiph == 2
            handleVis = 'on';
        else
            handleVis = 'off';
        end
        
        if icond == 1
            coefs_rt_fb_epiph = coefs_rt_fb_epiph_rep(:,iepiph);
            coefs_rt_fb_epiph_rnd = coefs_rt_fb_epiph_r_rnd(:,iepiph);
        else
            coefs_rt_fb_epiph = coefs_rt_fb_epiph_alt(:,iepiph);
            coefs_rt_fb_epiph_rnd = coefs_rt_fb_epiph_a_rnd(:,iepiph);
        end
        
        % REP and ALT conditions
        errorbar(iepiph+(icond-1.5)*.2,mean(coefs_rt_fb_epiph),std(coefs_rt_fb_epiph)/sqrt(nsubj),'Color',graded_rgb(icond,iepiph,2),...
                'HandleVisibility','off');
        scatter(iepiph+(icond-1.5)*.2,mean(coefs_rt_fb_epiph),50,mrkshape,'filled','MarkerEdgeColor',graded_rgb(icond,iepiph,4),'MarkerFaceColor',graded_rgb(icond,iepiph,2),...
                'HandleVisibility',handleVis);
%        text(iepiph+(icond-1.5)*.4,mean(coefs_rt_fb_epiph),sigstar(pvals_epiph(icond,iepiph)),'HorizontalAlignment','center');
        
        % RND conditions relative to the blocks
        errorbar(iepiph+(icond-1.5)*.2,mean(coefs_rt_fb_epiph_rnd),std(coefs_rt_fb_epiph_rnd)/sqrt(nsubj),'Color',graded_rgb(3,iepiph,2),...
                'HandleVisibility','off');
        scatter(iepiph+(icond-1.5)*.2,mean(coefs_rt_fb_epiph_rnd),50,mrkshape,'filled','MarkerEdgeColor',graded_rgb(3,iepiph,4),'MarkerFaceColor',graded_rgb(3,iepiph,2),...
                'HandleVisibility',handleVis);
%        text(iepiph+(icond-1.5)*.4,mean(coefs_rt_fb_epiph_rnd),sigstar(pvals_epiph_rnd(icond,iepiph)),'HorizontalAlignment','center');
    end
end

yline(0,':');
ylabel('Regression weight beta','FontSize',14);
xlabel('Quarters; circum-epiphany','FontSize',14);
xticks([1 2]);
xticklabels({'Pre', 'Post'});
xlim([.5 2.5]);
ylim([-.9 .1]);
legend({'Repeating','Random (locked to Rep.)','Alternating','Random (locked to Alt.)'},'Location','southeast');
title(sprintf('Effect of feedback value on reaction times\n(%d/%d subjects) Error bars: SEM',size(coefs_rt_fb_epiph_rnd,1),nsubj),'FontSize',12);

%% 3a. Organize: Correlation of RTs and feedback magnitude grouped on BIASED vs UNBIASED blocks

% Load epsilon-greedy percentages
load('out_fit_epsi.mat');
epsi(:,:,:,1) = [];
epsi(epsi<=.5) = 0;
epsi(epsi~=0) = 1;

bvals = zeros(nsubj,2); %isubj,ibias

for isubj = 1:nsubj
    rts_vec1 = [];
    rts_vec2 = [];
    rsp_vec1 = [];
    rsp_vec2 = [];
    for icond = 1:nc
        for iq = 1:4
            blockrange = 4*(iq-1)+1:4*(iq-1)+4;
            if epsi(isubj,icond,iq) == 0
                rts_vec1 = cat(1,rts_vec1,rts(blockrange,2:nt,icond,subjlist(isubj)));
                rsp_vec1 = cat(1,rsp_vec1,blcks(blockrange,1:nt-1,icond,subjlist(isubj)));
            else
                rts_vec2 = cat(1,rts_vec2,rts(blockrange,2:nt,icond,subjlist(isubj)));
                rsp_vec2 = cat(1,rsp_vec2,blcks(blockrange,1:nt-1,icond,subjlist(isubj)));
            end
        end 
    end
    
    % Regress
    for ibias = 1:2
        if ibias == 1
            rts_vec = rts_vec1(:);
            rsp_vec = rsp_vec1(:);
        else
            rts_vec = rts_vec2(:);
            rsp_vec = rsp_vec2(:);
        end
        bval = regress(rts_vec,[ones(size(rsp_vec)) rsp_vec]);
        bvals(isubj,ibias) = bval(2);
    end
end
bvals(bvals == 0) = nan;

%% 3b. Plot: Correlation of RTs and feedback magnitude grouped on BIASED vs UNBIASED blocks
figure;
hold on;
handleVis = 'off';
for icond = 1:nc
    for iq = 1:4
        if iq == 4
            handleVis = 'on';
        end
        scatter(iq,mean(coefs_rt_fb(:,iq,icond)),'filled','MarkerEdgeColor',graded_rgb(icond,iq,4),'MarkerFaceColor',graded_rgb(icond,iq,4),...
                'HandleVisibility',handleVis);
        errorbar(iq,mean(coefs_rt_fb(:,iq,icond)),std(coefs_rt_fb(:,iq,icond))/sqrt(nsubj),'Color',graded_rgb(icond,iq,4),...
                'HandleVisibility','off');
        text(iq+.1,mean(coefs_rt_fb(:,iq,icond)),sigstar(pvals(icond,iq)));
    end
    handleVis = 'off';
end

for ibias = 1:2

end
ylabel('Regression weight beta','FontSize',14);
legtxt = {'unbiased','biased'};
legend([legtxt,'sig:Condition (ANOVA)'],'Location','southwest');
title(sprintf('Effect of feedback value on reaction times\nError bars: SEM'),'FontSize',12);

%% local functions
function rgb = graded_rgb(ic,ib,nb)
    xc = linspace(.7,.2,nb);

    rgb =  [1,xc(ib),xc(ib); ...
               xc(ib),1,xc(ib); ...
               xc(ib),xc(ib),1];

    rgb = rgb(ic,:);
end
function stars = sigstar(p)
    if p <= .001
        stars = '***';
    elseif p <= .01
        stars = '**';
    elseif p <=.05
        stars = '*';
    else 
        stars = '';
    end
end
